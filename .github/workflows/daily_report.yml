name: ğŸŒŸ Daily GitHub Trending Report

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹è¿è¡Œ
  workflow_dispatch:   # å…è®¸ä½ æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®æµ‹è¯•

permissions:
  contents: write 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œé¿å… pull å†²çª

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: è¿è¡Œç”Ÿæˆè„šæœ¬
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: https://api.deepseek.com
          OPENAI_MODEL: deepseek-chat
        run: npm start

      - name: è‡ªåŠ¨æ›´æ–°é¦–é¡µ (index.html) å¹¶ä¿®å¤è·¯å¾„
        run: |
          # 1. ç¡®ä¿ reports æ–‡ä»¶å¤¹å­˜åœ¨ä¸”æœ‰æ–‡ä»¶
          if [ -d "reports" ] && [ "$(ls -A reports)" ]; then
            # æ‰¾åˆ°æ—¥æœŸæœ€æ–°çš„é‚£ä»½æŠ¥å‘Š
            LATEST_REPORT=$(ls -t reports/daily_*.html | head -1)
            echo "ä»Šæ—¥æœ€æ–°æŠ¥å‘Šæ˜¯: $LATEST_REPORT"
            
            # 2. æ ¸å¿ƒæ“ä½œï¼šå°†å…¶å¤åˆ¶ä¸ºæ ¹ç›®å½•çš„ index.html
            cp "$LATEST_REPORT" index.html
            
            # 3. è·¯å¾„ä¿®å¤ï¼ˆéå¸¸é‡è¦ï¼ï¼‰ï¼š
            sed -i 's/href="daily_/href="reports\/daily_/g' index.html
            sed -i 's/src="\.\.\//src="/g' index.html
            sed -i 's/href="\.\.\//href="/g' index.html
            
            echo "âœ… index.html å·²æ›´æ–°å¹¶å®Œæˆè·¯å¾„ä¿®æ­£"
          else
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° reports æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶å¤¹ä¸ºç©ºï¼"
            exit 1
          fi

      - name: 
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰å˜åŠ¨ï¼ŒåŒ…æ‹¬æ–°ç”Ÿæˆçš„ index.html
          git add data/ reports/ index.html
          
          # æäº¤æ›´æ”¹
          git commit -m "auto: ğŸŒŸ è‡ªåŠ¨ç”Ÿæˆä»Šæ—¥ç®€æŠ¥å¹¶æ›´æ–°é¦–é¡µ [skip ci]" || echo "ä»Šæ—¥æ•°æ®æ— å˜åŒ–"
          
          # å…ˆæ‹‰å–å¯èƒ½å­˜åœ¨çš„è¿œç¨‹æ”¹åŠ¨ï¼Œé˜²æ­¢å†²çª
          git pull origin main --rebase
          
          # æ¨é€
          git push origin main
