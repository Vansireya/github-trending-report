name: ğŸŒŸ Daily GitHub Trending Report

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: è¿è¡Œç”Ÿæˆè„šæœ¬
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: https://api.deepseek.com
          OPENAI_MODEL: deepseek-chat
        run: npm start

      - name: è‡ªåŠ¨æ›´æ–°é¦–é¡µå¹¶ä¿®å¤è·³è½¬é“¾æ¥
        run: |
          # 1. æ‰¾åˆ°æœ€æ–°ç”Ÿæˆçš„æŠ¥å‘Š
          LATEST_REPORT=$(ls -t reports/daily_*.html | head -1)
          
          # 2. å¤åˆ¶ä¸º index.html
          cp "$LATEST_REPORT" index.html
          
          # 3. ã€æ ¸å¿ƒä¿®å¤ã€‘è®© index.html é‡Œçš„å†å²é“¾æ¥æŒ‡å‘ reports/ æ–‡ä»¶å¤¹
          # è¿™æ ·ä½ åœ¨é¦–é¡µç‚¹å¼€â€œæ˜¨å¤©â€çš„æŠ¥å‘Šæ‰ä¸ä¼š File Not Found
          sed -i 's/href="daily_/href="reports\/daily_/g' index.html
          
          # 4. ä¿®å¤é™æ€èµ„æºè·¯å¾„ï¼ˆCSS/JSï¼‰
          sed -i 's/src="\.\.\//src="/g' index.html
          sed -i 's/href="\.\.\//href="/g' index.html
          
          echo "âœ… é¦–é¡µ index.html å·²ç”Ÿæˆå¹¶ä¼˜åŒ–è·¯å¾„"

      - name: æäº¤å¹¶æ¨é€åˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¿…é¡»åŒ…å« index.html
          git add data/ reports/ index.html
          
          # æ‹‰å–å¯èƒ½å­˜åœ¨çš„è¿œç¨‹å˜åŠ¨
          git pull origin main --rebase
          
          git commit -m "auto: ğŸŒŸ æ›´æ–°ä»Šæ—¥æŠ¥å‘ŠåŠå¯¼èˆªé¦–é¡µ" || echo "æ²¡æœ‰å˜åŒ–"
          git push origin main
